# jvm-基础

作者: fbk
时间：2023-1-28
地点：济南
## 运行时数据区
![](../img/2023-1-27/jvm%E4%B8%AD%E6%96%87.jpg)
在上阶段经历类的加载-验证-准备-解析-初始化阶段完成后，会在运行时数据区（Runtime Data Area）进行

1. 内存是非常重要的系统资源，是硬盘和CPU的中间仓库及桥梁，承载着操作系统和应用程序的实时运行。JVM内存布局规定了Java在运行过程中内存申请、分配、管理的策略，保证了JVM的高效稳定运行。不同的JVM对于内存的划分方式和管理机制存在着部分差异。结合JVM虚拟机规范，来探讨一下经典的JVM内存布局。

2. 我们通过磁盘或者网络IO得到的数据，都需要先加载到内存中，然后CPU从内存中获取数据进行读取，也就是说内存充当了CPU和磁盘之间的桥梁

![](../img/2023-1-28/ailjdk.jpg)
## 线程内存空间
![](../img/2023-1-28/%E7%BA%BF%E7%A8%8B%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4.png)
其中红的是线程共享的，包括堆内存和方法去，绿色的是每个线程单独拥有的，包括本地方法栈，虚拟机栈，方法区
## runtime
每个JVM只有一个Runtime实例，即为运行时环境
## 线程
### JVM线程
1. 线程是一个程序运行单元，一个JVM中可以包含多个线程
2. 在HostPot JVM中，每个线程都与操作系统的线程映射
  - 在JVM中创建了一个线程，此时操作系统的本地线程也同时创建，操作系统会调用java线程的run方法，执行完后，java线程销毁，操作系统线程销毁
### JVM系统线程
1. 虚拟机线程
2. 周期任务线程
3. GC线程
4. 编译线程
5. 信号调度线程
## 程序计数器（PC计数器）
### 作用
![](../img/2023-1-28/pc%E7%AE%80%E4%BB%8B.png)
`使用PC寄存器存储字节码指令地址有什么用呢？或者问为什么使用 PC 寄存器来记录当前线程的执行地址呢？`
1. 因为CPU需要不停切换线程，所以在线程切换完后，可以知道是从哪开始的
2. JVM的字节码解释器就需要通过改变PC寄存器的值来明确下一条应该执行什么样的字节码指令

`PC寄存器为什么被设定为私有的？`
1. 我们都知道所谓的多线程在一个特定的时间段内只会执行其中某一个线程的方法，CPU会不停地做任务切换，这样必然导致经常中断或恢复，如何保证分毫无差呢？为了能够准确地记录各个线程正在执行的当前字节码指令地址，最好的办法自然是为每一个线程都分配一个PC寄存器，这样一来各个线程之间便可以进行独立计算，从而不会出现相互干扰的情况。
2. 由于CPU时间片轮限制，众多线程在并发执行过程中，任何一个确定的时刻，一个处理器或者多核处理器中的一个内核，只会执行某个线程中的一条指令。
3. 这样必然导致经常中断或恢复，如何保证分毫无差呢？每个线程在创建后，都会产生自己的程序计数器和栈帧，程序计数器在各个线程之间互不影响。
## 本地方法栈
## 虚拟机栈
### 简介
1. 由于跨平台性的设计，java的指令都是根据栈来设计的，不同平台CPU的架构不同，所以不能设计为基于寄存器的【如果设计成基于寄存器的，耦合度高，性能会有所提升，因为可以对具体的CPU架构进行优化，但是跨平台性大大降低】。
2. 优点是跨平台，指令集小，编译器容易实现，缺点是性能下降，实现同样的功能需要更多的指令
### 内存中的栈和堆
1. 首先栈是运行时的单位，而堆是存储的单位。
2. 即：栈解决程序的运行问题，即程序如何执行，或者说如何处理数据。堆解决的是数据存储的问题，即数据怎么放，放哪里

### 基本内容
- 虚拟机栈是什么
  - java虚拟机栈，每个线程都会创建一个虚拟机栈，每个虚拟机栈储存多个栈帧，对应着一次次的java方法调用，栈是线程私有的
### 作用
- 主管java程序的运行，保存的是方法中的（8种基本数据，对象的引用地址），部分结果，方法的返回
### 特点
- 栈是一种快速有效的分配方式，访问速度仅次于程序计数器
- JVM直接对Java栈的操作只有两个：
  - 每个方法执行，伴随着进栈（入栈、压栈）
  - 执行结束后的出栈工作
- 对于栈来说不存在垃圾回收问题
- 栈不需要GC，但是可能存在OOM
### 虚拟机栈可能的异常
1. 当一个虚拟机栈的大小固定，每个线程创建请求的虚拟机栈容量超过虚拟机栈允许的最大容量，就会出现stackoverFlowError
2. java虚拟机栈会动态的扩展容量，如果没有申请到足够的内存，就会出现ssc（stackOutofMemory）
### 储存单位
- 每个线程都有自己的栈，栈中的数据都是以栈帧（Stack Frame）的格式存在
- 在这个线程上正在执行的每个方法都各自对应一个栈帧（Stack Frame）。
- 栈帧是一个内存区块，是一个数据集，维系着方法执行过程中的各种数据信息。
### 运行原理
### 内存结构
- 局部变量表
- 操作数栈
- 动态链接（或指向运行时常量池的方法引用）
- 方法返回地址
- 一些附加信息
## 局部变量表

